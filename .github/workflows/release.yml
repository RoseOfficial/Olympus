name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Download Dalamud
        run: |
          wget -q https://goatcorp.github.io/dalamud-distrib/stg/latest.zip -O dalamud.zip
          unzip -q dalamud.zip -d ~/dalamud

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore -p:DalamudLibPath=$HOME/dalamud/

      - name: Create Release Archive
        run: |
          cd bin/Release/Olympus
          zip -r ../../../Olympus.zip *

      - name: Extract Version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Generate repo.json
        run: |
          cat > repo.json << 'EOF'
          [
            {
              "Author": "Rose",
              "Name": "Olympus",
              "InternalName": "Olympus",
              "Punchline": "Intelligent White Mage rotation assistant",
              "Description": "Apollo: An intelligent White Mage rotation assistant that handles healing, damage, defensive cooldowns, and resource management with full level-sync awareness.",
              "ApplicableVersion": "any",
              "Tags": ["whm", "white-mage", "combat", "rotation"],
              "RepoUrl": "https://github.com/RoseOfficial/Olympus",
              "AssemblyVersion": "${{ steps.version.outputs.version }}",
              "DalamudApiLevel": 11,
              "DownloadLinkInstall": "https://github.com/RoseOfficial/Olympus/releases/download/${{ github.ref_name }}/Olympus.zip",
              "DownloadLinkTesting": "https://github.com/RoseOfficial/Olympus/releases/download/${{ github.ref_name }}/Olympus.zip",
              "DownloadLinkUpdate": "https://github.com/RoseOfficial/Olympus/releases/download/${{ github.ref_name }}/Olympus.zip"
            }
          ]
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: Olympus.zip
          generate_release_notes: true

      - name: Commit repo.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout main
          git add repo.json
          git commit -m "Update repo.json for ${{ github.ref_name }}"
          git push origin main
